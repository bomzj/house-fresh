<template>
<div>
<div class="navbar-cart">
	<a href="/#cart-modal" class="btn-open-cart" data-toggle="modal"><i class="fa fa-shopping-cart fa-2x"> </i>
		<span class="cart-items-count" v-if="items.length">{{ items.length }}</span>
	 </a>
</div>

<div class="cart-modal modal fade" id="cart-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-content">
        <div class="close-modal" data-dismiss="modal">
            <div class="lr">
                <div class="rl"></div>
            </div>
        </div>
		<h3 class="text-primary text-center">{{ items.length ? 'Выбранные товары': 'Ваша корзина пуста' }}</h3>
        <div class="container" v-show="items.length">
            
			<div class="row items-in-cart-block">
				<div v-for="item in items">
					<div class="row item-in-cart" >
						<div class="item-main-info col-xs-12 col-sm-12 col-md-7 col-lg-8">
							<div class="col-xs-6 col-sm-4 col-md-4 col-lg-4">
								<img :src="item.imageUrl" class="img-responsive cart-item-img" alt="">
							</div>
							<div class="col-xs-6 col-sm-8 col-md-8 col-lg-8">
								<h4 class="cart-item-text text-left">{{ item.title }}</h4>
								<h5 class="text-muted-italic text-left">({{ item.weight }} гр, {{ item.temperatureState }})</h5>
							</div>
						</div>
						<div class="item-count-info col-xs-12 col-sm-12 col-md-5 col-lg-4">
							<div class="col-xs-6 col-sm-4 col-md-6 col-lg-6">
								<div class="input-group">
									<span class="input-group-btn">
										<button class="btn btn-default" :disabled="item.count <= 1" @click="removeItem(item, 1)">
										  <i class="fa fa-minus"></i>
										</button>
									</span>
									<input class="form-control input-lg input-number" v-model.number="item.count" @input="preventInvalidCountInput" @click="selectAllText">
									<span class="input-group-btn">
										<button class="btn btn-default" @click="addItem(item, 1)">
										  <i class="fa fa-plus"></i>
										</button>
									</span>
								</div>
							</div>
							<div class="col-xs-4 col-sm-6 col-md-5 col-lg-5">
								<h4 class="cart-item-text cart-item-price">{{ getItemFullPrice(item) }} р</h4>
							</div>	
							<div class="col-xs-1 col-sm-2 col-md-1 col-lg-1">
								<button type="button" class="btn btn-default" @click="removeItem(item)">
									<i class="fa fa-remove fa-2x text-muted"></i>
								</button>
							</div>
						</div>
					</div>
					<div class="row separator">
						<hr class="hidden-md hidden-lg cart-items-separator">
					</div>
				</div>
								
				<hr class="hidden-xs hidden-sm gray">
			
				<div class="row total-price-block text-left">
					<h4 class="total-price-text">Итоговая сумма к оплате: </h4>
					<h4 class="total-price">  {{ getTotalPrice() }} р</h4>
				</div>
				
			</div>
			
			<div class="row personal-info-block">
				<h3 class="text-primary text-center">Введите Ваши данные</h3>
				<form @submit.prevent="onOrderFormSubmit">
					<div class="form-group user-info-input">
						<input type="text" class="form-control input-lg" placeholder="Ваше имя*" v-model="orderForm.name">
					</div>
					<div class="form-group user-info-input">
						<input type="phone" class="form-control input-lg" placeholder="Контактный телефон*" v-model="orderForm.phone">
					</div>
					<div class="form-group user-info-input">
						<input type="text" class="form-control input-lg" placeholder="Адрес доставки*" v-model="orderForm.address">
					</div>
					
					<p class="text-muted">Наши менеджеры свяжутся с Вами в течение 20 минут для подтверждения заказа. Если Вы не получили от нас звонок, пожалуйста, перезвоните нам по указанным в контактах телефонам.</p>
					
					<div class="row">
						<button class="btn btn-primary btn-xl" title="Заказать" :disabled="!isOrderFormValid()">Заказать</button>
					</div>
				</form>
			</div>
			
        </div>
    </div>
</div>
</div>
</template>

<script>
    export default {
        data: function () {
            return {
				items:[],
				orderForm: {
					name: '',
					phone: '',
					email: '',
					address: ''
				}
			};
        },
		// Track any kind of cart items changes and save to local storage
		watch: {
            items: {
                handler: function (val, oldVal) {
                    this.saveState();
                },
                deep: true
            }
        },
		methods: {
			addItem: function(item, count) {
				var foundItem = this.items.filter(i => i.id == item.id)[0];
				if (foundItem) {
					foundItem.count += count || 1;
				}
				else {
					item.count = count || 1;
					this.items.push(item);
				}
			},
			removeItem: function(item, count) {
				var index = this.items.indexOf(item);
				
				if (!count || count >= item.count) {
					this.items.splice(index, 1);
				}
				else {
					this.items[index].count -= count;
				}
			},
			getItemFullPrice: function(item) {
				var fullPrice = item.price * item.count;
				return Math.round(fullPrice * 100) / 100;
			},
			getTotalPrice: function() {
				var totalPrice = 0;
				for (var i = 0; i < this.items.length; i++) {
					totalPrice = Math.round((totalPrice + this.getItemFullPrice(this.items[i])) * 100) / 100;
				}
				return totalPrice;
			},
			preventInvalidCountInput: function (event) {
                var value = parseInt(event.target.value);
                var isValid = value >= 1 && value <= 999 && Math.floor(event.target.value) == value;
                
                if (!isValid) {
                    // reset to previous value
                    var resetEvent = document.createEvent('Event');
                    resetEvent.initEvent('input', true, true);
                    event.target.value = event.target._value;
                    event.target.dispatchEvent(resetEvent);
                }
            },
			selectAllText: function (event) {
                // event.target.select() is not working on Mobile Safari
                event.target.setSelectionRange(0, event.target.value.length);
            },
			saveState: function () {
				var json = JSON.stringify(this.items);
				localStorage.setItem("Cart", json);
			},
			loadState: function () {
				var json = localStorage.getItem("Cart");
				if (json) {
					this.items = JSON.parse(json);
				}
			},
			onOrderFormSubmit: function () {
				if (!this.isOrderFormValid()) return;
				
				
			},
			isOrderFormValid: function () {
				return this.orderForm.name && 
					this.orderForm.phone && 
					this.orderForm.address;
			}
		}
    }
</script>